<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js navy">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DOSSIER-TEMPLATE - The lcf_ui documentations</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/css/additional.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "navy";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../lcf-accueil.html">ACCUEIL</a></li><li class="chapter-item "><a href="../lcf-club.html">CLUB</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../club/club-accueil.html">ACCUEIL</a></li><li class="chapter-item "><a href="../club/club-candidature.html">CANDIDATURE</a></li><li class="chapter-item "><a href="../club/club-dossier.html">DOSSIER</a></li></ol></li><li class="chapter-item "><a href="../lcf-dcn.html">DCN</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dcn/dcn-accueil.html">ACCUEIL</a></li><li class="chapter-item "><a href="../dcn/dcn-parameters.html">PARAMETERS</a></li><li class="chapter-item "><a href="../dcn/dcn-dossier.html">DOSSIER</a></li></ol></li><li class="chapter-item expanded "><a href="../shared.html">SHARED</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shared/dossier-template.html" class="active">DOSSIER-TEMPLATE</a></li><li class="chapter-item "><a href="../shared/header.html">HEADER</a></li><li class="chapter-item "><a href="../shared/side-nav.html">SIDE-NAV</a></li><li class="chapter-item "><a href="../shared/page-not-found.html">PAGE-NOT-FOUND</a></li><li class="chapter-item "><a href="../shared/lcf-file.html">LCF-FILE</a></li><li class="chapter-item "><a href="../shared/lcf-terrain.html">LCF-TERRAIN</a></li><li class="chapter-item "><a href="../shared/lcf-radio.html">LCF-RADIO</a></li><li class="chapter-item "><a href="../shared/lcf-radio-three.html">LCF-RADIO-THREE</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The lcf_ui documentations</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dossier-template"><a class="header" href="#dossier-template">DOSSIER-TEMPLATE</a></h1>
<p>The template (parent component) for both <a href="../dcn/dcn-dossier.html">DCN-DOSSIER</a> and <a href="../club/club-dossier.html">CLUB-DOSSIER</a>.</p>
<h2 id="description"><a class="header" href="#description">Description:</a></h2>
<p>This component stores all core functionalities that will later be used by <a href="../dcn/dcn-dossier.html">DCN-DOSSIER</a> component and <a href="../club/club-dossier.html">CLUB-DOSSIER</a> component. These functionalities can be easily overriden if <a href="../dcn/dcn-dossier.html">DCN-DOSSIER</a> or <a href="../club/club-dossier.html">CLUB-DOSSIER</a> has different implementations from the original implementation.</p>
<h2 id="files"><a class="header" href="#files">Files:</a></h2>
<pre><code class="language-ignore">dossier-template.component.ts
</code></pre>
<h2 id="functionalities"><a class="header" href="#functionalities">Functionalities:</a></h2>
<h3 id="general"><a class="header" href="#general">General:</a></h3>
<pre><code class="language-ts">ngOnInit(): void {}
</code></pre>
<p>This is only a template that will later be used/overriden by <a href="../dcn/dcn-dossier.html">DCN-DOSSIER</a> component and <a href="../club/club-dossier.html">CLUB-DOSSIER</a> component. There will be no html or scss render by this component.</p>
<h3 id="specific"><a class="header" href="#specific">Specific:</a></h3>
<h4 id="initcriteresformandcriteresarrays"><a class="header" href="#initcriteresformandcriteresarrays">initCriteresFormAndCriteresArrays</a></h4>
<pre><code class="language-ts">initCriteresFormAndCriteresArrays(criteres: Critere[]) {
  for (let critere of criteres) {
    this.initCriteresForm(this.dossierForm, critere);
    switch (critere.id_ref_thematique_fk) {
      case 1:
        this.incon_struct_org.push(critere);
        break;
      case 2:
        if (critere.id_ref_type_critere_fk === 1)
          this.incon_insta_sport.push(critere);
        else if (critere.id_ref_type_critere_fk === 2)
          this.cumul_insta_sport.push(critere);
        break;
      case 3:
        if (critere.id_ref_type_critere_fk === 1)
          this.incon_trans_finan.push(critere);
        else if (critere.id_ref_type_critere_fk === 2)
          this.cumul_trans_finan.push(critere);
        break;
      case 4:
        this.cumul_struct_equip.push(critere);
        break;
      case 5:
        this.cumul_proj_sport.push(critere);
        break;
    }
  }
  // side effect: store all arrays in bigArray, later be used in html template
  this.critereBigArray = [
    [this.incon_struct_org, this.incon_insta_sport, this.incon_trans_finan],
    [
      this.cumul_insta_sport,
      this.cumul_struct_equip,
      this.cumul_trans_finan,
      this.cumul_proj_sport,
    ],
  ];
}
</code></pre>
<p>The objective of this function is to initiate the <a href="#initcriteresform"><code>criteresForm</code></a> of <code>dossierForm</code> and build a <code>critereBigArray</code> structure that match the dossier form in the UI. The <code>dossierForm</code> has the following structure:</p>
<ul>
<li>Criteres Incontournables (<code>id_ref_type_critere_fk === 1</code>):
<ul>
<li>Structuration et organisation du club</li>
<li>Installations Sportives</li>
<li>Transparence financière</li>
</ul>
</li>
<li>Criteres Cumulables (<code>id_ref_type_critere_fk === 2</code>):
<ul>
<li>Installations Sportives</li>
<li>Structuration des équipes et encadrement sportif</li>
<li>Transparence financière</li>
<li>Projet Sportif Jeunes</li>
</ul>
</li>
</ul>
<h4 id="updateterrainsrattachesarray"><a class="header" href="#updateterrainsrattachesarray">updateTerrainsRattachesArray</a></h4>
<pre><code class="language-ts">/**
   * Remove terrains with `te_nom` == `STADE EN SUPRESSION` and construct
   * `title` field in order to display it in select box
   */
updateTerrainsRattachesArray() {
  this.terrains = [];
  for (let terrain of this.storageService.getTerrains) {
    if (terrain.te_nom !== 'STADE EN SUPPRESSION')
      this.terrains.push({
        nni: terrain.nni,
        classement_eclairage: terrain.classement_eclairage,
        classement_installation: terrain.classement_installation,
        title:
          String(terrain.nni) +
          ' - ' +
          terrain.te_loca +
          ' - ' +
          terrain.te_nom,
      });
  }
}
</code></pre>
<p>This function is used to build an array that contains all the <code>filtered</code> terrains attached to the club. It is used in the select dropdown box in the <code>html</code>. The filtered array is a list of terrains that has <code>te_nom</code> different from <code>STADE EN SUPPRESSION</code>. Also note that, the list of terrains in <code>storage</code> has already been sorted by <code>nni</code> in the backend so we don't need to sort them in the frontend.</p>
<h4 id="initcriteresform"><a class="header" href="#initcriteresform">initCriteresForm</a></h4>
<pre><code class="language-ts">private initCriteresForm(dossierForm: FormGroup, critere: Critere) {
  switch (critere.id_ref_type_critere_fk) {
    case 1: // incontournables
      switch (critere.id_ref_thematique_fk) {
        case 1: // struct_org
          this.buildField('incon_struct_org', dossierForm, critere);
          break;
        case 2: // installation sportive
          this.buildField('incon_insta_sport', dossierForm, critere);
          break;
        case 3: // transparence financiere
          this.buildField('incon_trans_finan', dossierForm, critere);
          break;
      }
      break;
    case 2: // cumulables
      switch (critere.id_ref_thematique_fk) {
        // case 1: // struct_org
        //   this.buildField('cumul_struct_org', dossierForm, critere);
        //   break;
        case 2: // installation sportive
          this.buildField('cumul_insta_sport', dossierForm, critere);
          break;
        case 3: // transparence financiere
          this.buildField('cumul_trans_finan', dossierForm, critere);
          break;
        case 4:
          this.buildField('cumul_struct_equip', dossierForm, critere);
          break;
        case 5:
          this.buildField('cumul_proj_sport', dossierForm, critere);
          break;
      }
      break;
  }
}

private buildField(
  field_name: string,
  dossierForm: FormGroup,
  critere: Critere
) {
  switch (critere.code) {
    case 'TERRAIN':
      this.addTerrain(dossierForm, field_name, critere);
      break;
    case 'RB':
      this.addRadio(dossierForm, field_name, critere);
      break;
    case 'RB3':
      this.addRadioThree(dossierForm, field_name, critere);
      break;
    case 'PJ':
      this.addFile(dossierForm, field_name, critere);
      break;
    case 'WBS':
      this.addRadio(dossierForm, field_name, critere);
      break;
  }
}

private addTerrain(
  dossierForm: FormGroup,
  form_field: string,
  critere: Critere
) {
  let fieldGroup = dossierForm.get(form_field) as FormGroup;

  fieldGroup.addControl(
    String(critere.id),
    this.fb.group({
      search: [''],
      rattache: [critere.valeur],
      terrain: [
        critere.nni
          ? {
              classement_eclairage: critere.classement_eclairage,
              classement_installation: critere.classement_installation,
              nni: critere.nni,
            }
          : null,
      ],
      libelle: [critere.libelle],
      id: [critere.id],
      type: [critere.code],
      eligibilite: [critere.eligibilite],
      ref_eligibilite: [critere.eligibilite],
      nb_points_calcule: [critere.nb_points_calcule],
      nb_points_max: [critere.nb_points_max],
      nb_points_min: [critere.nb_points_min],
      code: [critere.id_ref_thematique_fk],
      modification_manuelle: [critere.modification_manuelle],
    })
  );
}

private addRadio(
  dossierForm: FormGroup,
  form_field: string,
  critere: Critere
) {
  let fieldGroup = dossierForm.get(form_field) as FormGroup;
  fieldGroup.addControl(
    String(critere.id),
    this.fb.group({
      valeur: [critere.valeur],
      libelle: [critere.libelle],
      id: [critere.id],
      type: [critere.code],
      eligibilite: [critere.eligibilite],
      ref_eligibilite: [critere.eligibilite],
      nb_points_calcule: [critere.nb_points_calcule],
      nb_points_max: [critere.nb_points_max],
      nb_points_min: [critere.nb_points_min],
      code: [critere.id_ref_thematique_fk],
    })
  );
}

private addRadioThree(
  dossierForm: FormGroup,
  form_field: string,
  critere: Critere
) {
  let fieldGroup = dossierForm.get(form_field) as FormGroup;
  fieldGroup.addControl(
    String(critere.id),
    this.fb.group({
      valeur: [critere.valeur],
      libelle: [critere.libelle],
      id: [critere.id],
      type: [critere.code],
      eligibilite: [critere.eligibilite],
      ref_eligibilite: [critere.eligibilite],
      nb_points_calcule: [critere.nb_points_calcule],
      nb_points_max: [critere.nb_points_max],
      nb_points_min: [critere.nb_points_min],
      radio_label: [critere.radio_label],
      code: [critere.id_ref_thematique_fk],
    })
  );
}

private addFile(
  dossierForm: FormGroup,
  form_field: string,
  critere: Critere
) {
  let fieldGroup = dossierForm.get(form_field) as FormGroup;
  fieldGroup.addControl(
    String(critere.id),
    this.fb.group({
      statut_general: [critere.statut_manager_general],
      file: [
        null,
        !critere.eligibilite || critere.eligibilite === 4
          ? Validators.required
          : null,
      ],
      azure_name: [critere.azure_name],
      file_name: [critere.file_name],
      new_file_name: [null],
      ref_file_name: [critere.file_name],
      libelle: [critere.libelle],
      id: [critere.id],
      type: [critere.code],
      eligibilite: [critere.eligibilite],
      ref_eligibilite: [critere.eligibilite], // previous status stored in database
      motif_pj: [critere.motif_pj],
      ref_motif_pj: [critere.motif_pj], // previous motif stored in database
      code: [critere.id_ref_thematique_fk],
    })
  );
}
</code></pre>
<p>Above are <code>critreresForm</code> dynamic building functions. Depending on the <code>critere.type</code> (PJ, TERRAIN, RB, RB3 or WBS), we'll generate the corresponding form control. It will be used together with <a href="#initinfogenerale">initInfoGenerale</a> to create a <code>dossierForm</code>.</p>
<h4 id="initinfogenerale"><a class="header" href="#initinfogenerale">initInfoGenerale</a></h4>
<pre><code class="language-ts">private initInfoGenerale() {
  let info_general = this.dossierForm.get('info_general') as FormGroup;
  info_general.patchValue({
    nom: this.dossier.referent_nom,
    prenom: this.dossier.referent_prenom,
    email: this.dossier.referent_mail,
    tel: this.dossier.referent_telephone,
    autorisation: this.dossier.autorisation_adhesion,
  });
}
</code></pre>
<p>This function initiate the <code>Information Generale</code> field of <code>dossierForm</code>. It will later be used together with <a href="#initcriteresform">initCriteresForm</a> to create a <code>dossierForm</code></p>
<h4 id="resetallcriterearrays"><a class="header" href="#resetallcriterearrays">resetAllCritereArrays</a></h4>
<pre><code class="language-ts">/**
 * In order to avoid the bug where child component rerenders 2 times,
 * we reset all arrays before pushing new criteres to those arrays
 */
resetAllCritereArrays() {
  this.incon_struct_org = [];
  this.incon_insta_sport = [];
  this.incon_trans_finan = [];
  this.cumul_insta_sport = [];
  this.cumul_trans_finan = [];
  this.cumul_struct_equip = [];
  this.cumul_proj_sport = [];
}
</code></pre>
<p>This function resets all critere arrays. It is needed to overcome a known bug in Angular: <a href="https://github.com/angular/angular/issues/28330">https://github.com/angular/angular/issues/28330</a></p>
<h4 id="isempty"><a class="header" href="#isempty">isEmpty</a></h4>
<pre><code class="language-ts">/**
 * Check if object is an empty array or an empty json
 */
isEmpty(object: any) {
  if (object) return Object.keys(object).length === 0;
  else return true;
}
</code></pre>
<p>This is just a helper function which helps to detect whether an object is empty or not.</p>
<h4 id="backupdossier"><a class="header" href="#backupdossier">backupDossier</a></h4>
<pre><code class="language-ts">/**
 * Request `dossier` from backend.
 * In case not found, navigate to page `404`
 */
backupDossier() {
  const sa_no = this.storageService.selectedSaisonSaNo;
  const cl_cod = this.storageService.cl_cod;
  const compet_id = this.storageService.competId;
  this.subs.sink = this.dossierService
    .requestDossier(sa_no, cl_cod, compet_id)
    .pipe(takeUntil(this.storageService.globalUnsubscribe))
    .subscribe({
      next: (dossier: Dossier) =&gt; {
        console.log('backupDossier: ', dossier);
        this.dossier = dossier;
        this.storageService.selectedDossier = dossier;
      },
      error: (err: any) =&gt; {
        console.error(err);
        this.router.navigate(['/', this.storageService.connectId, '404']);
      },
    });
}
</code></pre>
<p>This function is called if and only if user refresh the dossier page. When the page is refreshed, <code>LCF</code> will reset its internal memory which leads to no <code>dossier</code> state in <code>storage</code>. Therefore, we have to get another <code>dossier</code> from backend and reput it into the frontend <code>storage</code>.</p>
<h4 id="validerdossier"><a class="header" href="#validerdossier">validerDossier</a></h4>
<pre><code class="language-ts">validerDossier() {
  let isValid = this.isDossierFormValid(this.dossierForm);
  if (this.dossier.id &amp;&amp; isValid) {
    this.sendDossierToBackend(
      true,
      this.storageService.connectId,
      'Validation réussi'
    );
  } else {
    if (!this.dossier.id) {
      console.error('dossier.id is undefined or null');
      console.info('dossier info:', this.dossier);
    } else if (!isValid) {
      console.error('The dossierForm is invalid!');
      console.info('dossierForm info:', this.dossierForm);
    }
  }
}
</code></pre>
<p>This function is called after user click on <code>VALIDER</code> button on the <code>dossier</code> page. It will check if <code>dossierForm</code> is valid then send the <code>dossierForm</code> to backend.</p>
<h4 id="savedossier"><a class="header" href="#savedossier">saveDossier</a></h4>
<pre><code class="language-ts">/**
 * save `dossier` without checking if form is valid
 * still checking if info_general is valid though
 */
saveDossier() {
  let info_general = this.dossierForm.get('info_general') as FormGroup;
  let is_info_general_valid = this.isInfoGeneralValid(info_general);
  if (this.dossier.id &amp;&amp; is_info_general_valid) {
    this.sendDossierToBackend(
      false,
      this.storageService.connectId,
      'Enregistrement réussi'
    );
  } else {
    if (!this.dossier.id) {
      console.error('dossier.id is undefined or null');
      console.info('dossier info:', this.dossier);
    } else if (!is_info_general_valid) {
      console.error('The info_general is invalid!');
      console.info(
        'dossierForm info:',
        this.dossierForm.controls['info_general']
      );
    }
  }
}
</code></pre>
<p>This function is called after user click on <code>ENREGISTRER</code> button on the <code>dossier</code> page. It will check only if <code>Information Generale</code> field is valid then send the <code>dossierForm</code> to backend.</p>
<h4 id="senddossiertobackend"><a class="header" href="#senddossiertobackend">sendDossierToBackend</a></h4>
<pre><code class="language-ts">sendDossierToBackend(
  isDossierValid: boolean,
  connectId: string,
  success_message: string
) {
  this.subs.sink = this.dossierService
    .sendDossier(
      Number(this.dossier.id),
      Number(this.dossier.id_statuts_dossier_fk),
      this.dossierForm,
      isDossierValid,
      connectId,
      this.eligibleOfIncon$.value,
      this.sumOfCumulable$.value,
      this.totalPoints$.value,
      this.aideFinanciere$.value
    )
    .pipe(
      switchMap((result: any) =&gt; {
        console.log('backendResponse:', result);
        const dossier$ = this.dossierService.requestDossier(
          this.storageService.selectedSaisonSaNo,
          this.storageService.cl_cod,
          this.storageService.competId
        );
        const dossiers$ = this.dossierService.requestDossiers(
          this.storageService.selectedSaisonSaNo,
          this.storageService.cl_cod
        );
        return combineLatest([dossiers$, dossier$]);
      })
    )
    .subscribe(([dossiers, dossier]) =&gt; {
      console.log('storage.dossiers:', dossiers);
      console.log('storage.selectedDossier:', dossier);
      this.storageService.selectedDossier = dossier;
      this.storageService.dossiers = dossiers;
      this.messageService.add({
        severity: 'success',
        summary: 'Succès',
        detail: success_message,
      });
    });
}
</code></pre>
<p>This function is used to send a <code>dossierForm</code> with some other important variables (.e.g <code>points calculation</code>) to backend and then retrieve a new <code>dossier</code> + <code>dossiers</code> from backend and put it into <code>storage</code>. It also allows us to customize the toastr <code>success_message</code> which appears after the <code>dossierForm</code> has been successfully sent.
The <code>isDossierValid</code> parameter is just there to differentiate situations where user clicked on <code>ENREGISTRER</code> button (dossier not valid but it's ok to be sent) or <code>VALIDER</code> button.</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>VALIDER</th><th>ENREGISTRER</th></tr></thead><tbody>
<tr><td>isDossierValid</td><td>true</td><td>false</td></tr>
</tbody></table>
</div>
<h4 id="isdossierformvalid"><a class="header" href="#isdossierformvalid">isDossierFormValid</a></h4>
<pre><code class="language-ts">isDossierFormValid(dossierForm: FormGroup): boolean {
  let info_general = dossierForm.get('info_general') as FormGroup;
  let validToken1 = this.isInfoGeneralValid(info_general);
  let validToken2: boolean = true;
  for (let formField of UtilsService.fieldArray) {
    let criteresField = dossierForm.get(formField) as FormGroup;
    validToken2 =
      this.isCritereValid(criteresField, formField) &amp;&amp; validToken2;
  }
  return validToken1 &amp;&amp; validToken2;
}
</code></pre>
<p>This function return whether or not a dossier is <code>valid</code>.</p>
<h4 id="isinfogeneralvalid"><a class="header" href="#isinfogeneralvalid">isInfoGeneralValid</a></h4>
<pre><code class="language-ts">private isInfoGeneralValid(info_general: FormGroup): boolean {
  let validToken: boolean = true;
  // check validity of nom and prenom

  for (let field of ['nom', 'prenom']) {
    if (
      !info_general.controls[field].valid &amp;&amp;
      info_general.controls[field].enabled
    ) {
      this.messageService.add({
        severity: 'error',
        summary: UtilsService.toReadableString(field) + ' Incomplet',
        detail: 'Veuillez saisir le ' + field + ' du référent du dossier',
        // sticky: true,
      });
      validToken = false;
    }
  }

  // check validity of email
  if (
    !info_general.controls['email'].valid &amp;&amp;
    info_general.controls['email'].enabled
  ) {
    this.messageService.add({
      severity: 'error',
      summary: 'Email Invalide',
      detail: 'Mail du référent invalide',
      // sticky: true,
    });
    validToken = false;
  }

  // check validity of telephone
  if (
    !info_general.controls['tel'].valid &amp;&amp;
    info_general.controls['tel'].enabled
  ) {
    this.messageService.add({
      severity: 'error',
      summary: 'Telephone Invalide',
      detail:
        'Numéro de téléphone invalide. Caractères autorisés: chiffres, +, -, (), espaces',
      // sticky: true,
    });
    validToken = false;
  }

  // check validity of autorisation
  if (
    !info_general.controls['autorisation'].valid &amp;&amp;
    info_general.controls['autorisation'].enabled
  ) {
    this.messageService.add({
      severity: 'error',
      summary: 'Autorisations Incomplet',
      detail:
        &quot;Veuillez accepter les mentions d'autorisation FFF en haut de la page&quot;,
      // sticky: true,
    });
    validToken = false;
  }

  return validToken;
}
</code></pre>
<p>This function returns whether or not the <code>Information Generale</code> field is valid. It will later be used in <a href="#isdossierformvalid">isDossierFormValid</a> function. Note that, a <code>disabled</code> field will be considered as <code>valid</code> too.</p>
<h4 id="iscriterevalid"><a class="header" href="#iscriterevalid">isCritereValid</a></h4>
<pre><code class="language-ts">private isCritereValid(criteresField: FormGroup, formField: string): boolean {
  let validToken = true;
  Object.keys(criteresField.controls).forEach((id: string, index: number) =&gt; {
    let position = index + 1;
    switch (criteresField.get([id, 'type'])?.value) {
      case 'PJ':
        if (
          !criteresField.get([id, 'file'])?.valid &amp;&amp;
          criteresField.get([id, 'file'])?.enabled
        ) {
          this.messageService.add({
            severity: 'error',
            summary:
              UtilsService.toReadableString(formField) +
              ': Critère ' +
              position +
              ' Incomplet',
            detail: 'Veuillez insérer une pièce jointe',
            // sticky: true,
          });
          validToken = false;
        }
        break;

      case 'TERRAIN':
        if (
          !criteresField.get([id, 'terrain'])?.valid &amp;&amp;
          criteresField.get([id, 'terrain'])?.enabled
        ) {
          this.messageService.add({
            severity: 'error',
            summary:
              UtilsService.toReadableString(formField) +
              ': Critère ' +
              position +
              ' Incomplet',
            detail:
              'Vous devez sélectionner une installation dans la liste déroulante, ou cliquer sur &quot;Pas d\'installation&quot;',
            // sticky: true,
          });
          validToken = false;
        }
        break;

      case 'RB':
        if (
          !criteresField.get([id, 'valeur'])?.valid &amp;&amp;
          criteresField.get([id, 'valeur'])?.enabled
        ) {
          this.messageService.add({
            severity: 'error',
            summary:
              UtilsService.toReadableString(formField) +
              ': Critère ' +
              position +
              ' Incomplet',
            detail: 'Vous devez donner une réponse (Oui ou Non)',
            // sticky: true,
          });
          validToken = false;
        }
        break;

      case 'RB3':
        if (
          !criteresField.get([id, 'valeur'])?.valid &amp;&amp;
          criteresField.get([id, 'valeur'])?.enabled
        ) {
          this.messageService.add({
            severity: 'error',
            summary:
              UtilsService.toReadableString(formField) +
              ': Critère ' +
              position +
              ' Incomplet',
            detail: 'Vous devez donner une réponse (Oui ou Non)',
            // sticky: true,
          });
          validToken = false;
        }
        break;

      case 'WBS':
        //TODO
        break;
    }
  });
  return validToken;
}
</code></pre>
<p>This function returns whether or not a <code>Critere</code> field is valid. It will later be used in <a href="#isdossierformvalid">isDossierFormValid</a> function. Note that, a <code>disabled</code> field will be considered as <code>valid</code> too. If a <code>critere</code> is not valid, we provide an error message indicates which and where the invalid event occurs. Putting the <code>formField</code> into function <a href="">toReadableString</a> will result in a more comprehensive critere location message.</p>
<h4 id="setcompetidicon"><a class="header" href="#setcompetidicon">setCompetIdIcon</a></h4>
<pre><code class="language-ts">// set up classes with conditions later be used by ngClass in the html template
setCompetIdIcon() {
  this.compet_id_icon = {
    national: Number(this.dossier.id_ref_competitions_fk) &gt;= 1,
    feminin: this.dossier.id_ref_competitions_fk === 4,
    futsal: this.dossier.id_ref_competitions_fk === 5,
  };
}
</code></pre>
<p>This function sets up a ngClass for competition icon later be used in the html template.</p>
<h4 id="setdossierstatuscolor"><a class="header" href="#setdossierstatuscolor">setDossierStatusColor</a></h4>
<pre><code class="language-ts">// set up classes with conditions later be used by ngClass in the html template
setDossierStatusColor() {
  this.dossier_status_color = {
    red: this.dossier.id_statuts_dossier_fk === 1,
    yellow: this.dossier.id_statuts_dossier_fk === 2,
    green: this.dossier.id_statuts_dossier_fk === 3,
  };
}
</code></pre>
<p>This function sets up a ngClass for dossier statut color later be used in the html template.</p>
<h4 id="checksanofromurl"><a class="header" href="#checksanofromurl">checkSaNoFromUrl</a></h4>
<pre><code class="language-ts">/**
 * Check `sa_no` from `url` is in range of `user.saisons.sa_no`.
 * If true, set `selectedSaison` in `Store` to `sa_no`.
 * If false, navigate to page 404
 */
checkSaNoFromUrl(): void {
  const saisonSaNoFromUrl = Number(this.route.snapshot.paramMap.get('sa_no'));
  this.user = this.storageService.user;
  if (this.storageService.checkSaisonInRange(this.user, saisonSaNoFromUrl)) {
    this.storageService.selectedSaisonSaNo = saisonSaNoFromUrl;
  } else {
    this.router.navigate(['/', this.storageService.connectId, '404']);
  }
}
</code></pre>
<p>This function check <code>sa_no</code> from <code>url</code> to see if it is in range of <code>user.saisons.sa_no</code>.</p>
<ul>
<li>If true, set <code>selectedSaison</code> in <code>storage</code> to <code>sa_no</code></li>
<li>If false, navigate to page 404</li>
</ul>
<h4 id="getcompetidfromurl"><a class="header" href="#getcompetidfromurl">getCompetIdFromUrl</a></h4>
<pre><code class="language-ts">getCompetIdFromUrl() {
  const competition = this.route.snapshot.paramMap.get('competition');
  if (competition) {
    this.storageService.competId = Number(
      UtilsService.getCodeByCompetition(competition)
    );
  }
}
</code></pre>
<p>This function get the <code>competition</code> string in <code>url</code>, convert it to a number then store it in <code>storage</code>.</p>
<h4 id="uploadfile"><a class="header" href="#uploadfile">uploadFile</a></h4>
<pre><code class="language-ts">uploadFile(file: any, field_name: string, critere_id: number) {
  let fileForm = this.dossierForm.get([
    field_name, // form field which has critere.code == 'PJ' .i.e 'incon_struct_org'
    String(critere_id),
  ]);
  if (file) {
    const reader: FileReader = new FileReader();
    reader.readAsDataURL(file); // read as base64
    reader.onload = () =&gt; {
      const { categorie, nature } = UtilsService.getCategorieNatureById(
        fileForm?.value.id
      );
      const fileToUpload = {
        file_name: file.name,
        content: String(reader.result).split(',')[1], // strip the first part before the comma
        content_type: file.type,
        categorie: categorie,
        nature: nature,
      };
      // upload a file with content
      fileForm?.patchValue({
        file: fileToUpload,
        eligibilite: 1, // set status to en attente FFF after uploading a file
        motif_pj: '', // reset motif_pj to ''
      });
    };
  }
  // upload nothing (file == null)
  else {
    fileForm?.patchValue({
      file: null,
      // if file uploading is null, restore eligibilite to the eligibilite value in backend
      eligibilite: fileForm.value.ref_eligibilite,
    });
  }
}
</code></pre>
<p>This function parses the uploaded <code>file</code> as <code>base64</code> format and update its <code>fileForm</code> value. If the user remove the <code>file</code>, the <code>eligibilite</code> of the <code>fileForm</code> will be reset to its <code>ref_eligibilite</code> (considered as a <code>const</code> in frontend) which is the original value gotten from backend.</p>
<p>For example, in the case of <code>REFUS_PIECE</code>, the current eligibilite is <code>refus piece</code>, the user (<code>club</code>) will upload another file to the frontend, the eligibilite will pass to <code>en attent FFF</code>. To undo the change, user will remove the file by clicking on <code>Cancel</code> after the file upload window pop up. The eligibilite will now return to its original value which is <code>refus piece</code>.</p>
<h4 id="downloadfile"><a class="header" href="#downloadfile">downloadFile</a></h4>
<pre><code class="language-ts">/**
 * WIP - can be improved by linking to storage on Azure Stack Edge
 * https://cdn-transverse.azureedge.net
 */
async downloadFile(file: any) {
  this.subs.sink = this.dossierService
    .requestDownloadFile(
      file.categorie,
      file.nature,
      file.azure_name ? file.azure_name : null
    )
    .subscribe({
      next: (result: any) =&gt; {
        UtilsService.open_file(result);
      },
      error: (err: any) =&gt; {
        console.error(err);
      },
    });
}
</code></pre>
<p>This function is used to open a new tab that allows user to view the <code>PDF</code> file which is stored in <code>AzureStorage</code>. User can later decide whether or not to download the file.</p>
<h4 id="spawndossierobservableandinitdossierformassideeffects"><a class="header" href="#spawndossierobservableandinitdossierformassideeffects">spawnDossierObservableAndInitDossierFormAsSideEffects</a></h4>
<pre><code class="language-ts">/**
 * Create a `dossier$` stream. After subscribing to this stream,
 * a `dossierForm` building + some setup processes will be initialized as side effects
 */
private spawnDossierObservableAndInitDossierFormAsSideEffects() {
  return this.storageService.selectedDossier$.pipe(
    // side effects if subscribe to this stream
    tap((dossier: Dossier) =&gt; {
      if (dossier.criteres) {
        this.dossier = dossier;
        this.resetAllCritereArrays();
        // init dossierForm
        this.initInfoGenerale();
        this.initCriteresFormAndCriteresArrays(dossier.criteres);
        // setting ngClass object in html
        this.setCompetIdIcon();
        this.setDossierStatusColor();
        // init eligibleOfIncon$
        this.eligibleOfIncon$.next(
          this.dossierService.getInconEligibilite(this.dossierForm)
        );
        // init sumOfCumulable$
        this.sumOfCumulable$.next(
          this.dossierService.getSumOfCumulPoints(this.dossierForm)
        );
        // init totalPoints$
        this.totalPoints$.next(
          this.dossierService.getPointFromEligibilite(
            this.eligibleOfIncon$.value
          ) + this.sumOfCumulable$.value
        );
        // init aideFinanciere$
        this.aideFinanciere$.next(
          this.dossierService.calculAideFinan(
            this.storageService.competId,
            this.eligibleOfIncon$.value,
            this.totalPoints$.value
          )
        );
      }
    }),
    takeUntil(this.storageService.globalUnsubscribe)
  );
}
</code></pre>
<p>This function will create a <code>dossier$</code> stream. After subscribing to this stream, a <code>dossierForm</code> building + some setup processes will be initialized as side effects</p>
<h4 id="subscribeeligiblefromdossier"><a class="header" href="#subscribeeligiblefromdossier">subscribeEligibleFromDossier</a></h4>
<pre><code class="language-ts">/** Subscribe to `dossier$`, switch the stream to `Incontournables` Observable,
 * calculate the `eligibilite` in `Incontournables`, also update `totalPoints` and `aideFinanciere`
 */
private subscribeEligibleFromDossier(dossier$: Observable&lt;Dossier&gt;) {
  return dossier$
    .pipe(
      switchMap(() =&gt; {
        return this.dossierService.eligibleChangeObserver(this.dossierForm);
      })
    )
    .subscribe({
      next: () =&gt; {
        this.eligibleOfIncon$.next(
          this.dossierService.getInconEligibilite(this.dossierForm)
        );
        this.totalPoints$.next(
          this.dossierService.getPointFromEligibilite(
            this.eligibleOfIncon$.value
          ) + this.sumOfCumulable$.value
        );
        this.aideFinanciere$.next(
          this.dossierService.calculAideFinan(
            this.storageService.competId,
            this.eligibleOfIncon$.value,
            this.totalPoints$.value
          )
        );
      },
      error: (err: any) =&gt; {
        console.error(err);
      },
    });
}
</code></pre>
<p>This function subscribe to <code>dossier$</code> stream, then switch the stream to <code>Incontournables</code> observable, calculate the <code>eligibilite</code> in <code>Criteres Incontournables</code> field, it also updates <code>totalPoints</code> and <code>aideFinanciere</code>. This function will later be used in <a href="#setupdossiercontent">setupDossierContent</a> function.</p>
<h4 id="subscribecumulablefromdossier"><a class="header" href="#subscribecumulablefromdossier">subscribeCumulableFromDossier</a></h4>
<pre><code class="language-ts">/** Subscribe to `dossier$`, switch the stream to `Cummulables` Observable,
 * calculate the `points` in `Cumulables`, also update `totalPoints` and `aideFinanciere`
 */
private subscribeCumulableFromDossier(dossier$: Observable&lt;Dossier&gt;) {
  return dossier$
    .pipe(
      switchMap(() =&gt; {
        return this.dossierService.pointsChangeObserver(this.dossierForm);
      })
    )
    .subscribe({
      next: () =&gt; {
        this.sumOfCumulable$.next(
          this.dossierService.getSumOfCumulPoints(this.dossierForm)
        );
        this.totalPoints$.next(
          this.dossierService.getPointFromEligibilite(
            this.eligibleOfIncon$.value
          ) + this.sumOfCumulable$.value
        );
        this.aideFinanciere$.next(
          this.dossierService.calculAideFinan(
            this.storageService.competId,
            this.eligibleOfIncon$.value,
            this.totalPoints$.value
          )
        );
      },
      error: (err: any) =&gt; {
        console.error(err);
      },
    });
}
</code></pre>
<p>This function subscribes to <code>dossier$</code> stream, then switch the stream to <code>Cummulables</code> observable, calculate the <code>points</code> in <code>Criteres Cumulables</code> field, it also updates <code>totalPoints</code> and <code>aideFinanciere</code>. This function will later be used in <a href="#setupdossiercontent">setupDossierContent</a> function.</p>
<h4 id="setupdossiercontent"><a class="header" href="#setupdossiercontent">setupDossierContent</a></h4>
<pre><code class="language-ts">/**
 * Spawn `dossier$` and init `dossierForm` in its side effects.
 * Immediately subscribe to `eligibilite$` and `cumulables$` piped from `dossier$`
 * in order to calculate `incontournables` eligibilite, `cumulables` points and `totalPoints`
 */
setupDossierContent() {
  this.subs.sink = this.subscribeEligibleFromDossier(
    this.spawnDossierObservableAndInitDossierFormAsSideEffects()
  );
  this.subs.sink = this.subscribeCumulableFromDossier(
    this.spawnDossierObservableAndInitDossierFormAsSideEffects()
  );
}
</code></pre>
<p>This function will spawn a <code>dossier$</code> stream and init <code>dossierForm</code> in its side effects. Immediately after that, we switch the stream to <code>eligibilite$</code> stream and <code>cumulables$</code> stream in order to calculate <code>Criteres Incontournables</code> eligibilite, <code>Criteres Cumulables</code> points and <code>totalPoints</code>.</p>
<h4 id="ngafterviewchecked"><a class="header" href="#ngafterviewchecked">ngAfterViewChecked</a></h4>
<pre><code class="language-ts">ngAfterViewChecked(): void {
    this.cdRef.detectChanges();
  }
</code></pre>
<p>Because there are some proccesses such as setting competition icon, dossier statut color, etc... are initiated after the view is checked (because a <code>dossier</code> in <code>dossier$</code> stream could be updated at anytime after the view was checked, a http request could take a while to get the response). Therefore, we have to implement another change detection after the view is checked. Our application is just a small one so it does not impact much on the performance nor user experience.</p>
<h4 id="ngondestroy"><a class="header" href="#ngondestroy">ngOnDestroy</a></h4>
<pre><code class="language-ts">ngOnDestroy(): void {
  // unhide saisonBox
  this.storageService.showSaisonBox$.next(true);
  this.subs.unsubscribe();
  this.storageService.globalUnsubscribe.next();
  this.storageService.globalUnsubscribe.complete();
}
</code></pre>
<p>Upon destroying this component, we unhide the season selection dropdown box. We also terminate all the <code>dangling</code> observables (this is important, we did it to overcome the <code>child component duplication</code> bug)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../shared.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../shared/header.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../shared.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../shared/header.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
